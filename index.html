<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Questify: Smart Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-flow-1: #e0f2fe;
            --bg-flow-2: #f0f9ff;
            --bg-flow-3: #eff6ff;
            --card-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(0, 0, 0, 0.08);
            --text-main: #000000;
            --text-muted: #333333;
            --input-placeholder: #666666;
        }

        .dark-mode {
            --bg-flow-1: #0f172a;
            --bg-flow-2: #1e1b4b;
            --bg-flow-3: #172554;
            --card-bg: rgba(15, 23, 42, 0.92);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #cccccc;
            --input-placeholder: #999999;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-size: 400% 400%;
            background-image: linear-gradient(-45deg, var(--bg-flow-1), var(--bg-flow-2), var(--bg-flow-3));
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            transition: color 0.3s ease, background-image 0.5s ease;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Animations --- */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-enter { animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.2s ease-out; }

        /* --- Components --- */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px -5px var(--glass-border);
            transition: all 0.3s ease;
        }

        .btn-press {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .btn-press:active { transform: scale(0.95); }
        
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        ::placeholder { color: var(--input-placeholder) !important; opacity: 1; }
        
        .xp-bar-container {
            background: rgba(0,0,0,0.05);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .dark-mode .xp-bar-container { background: rgba(255,255,255,0.1); }

        #toast-container {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
            z-index: 100; pointer-events: none; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px;
        }
        .toast {
            background: #000000; color: #ffffff;
            padding: 12px 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 10px;
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .dark-mode .toast { background: #ffffff; color: #000000; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen pb-24 px-4 overflow-hidden-x">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Hidden Reset -->
    <button id="resetBtn" onclick="triggerReset()" class="fixed top-4 left-4 z-50 hidden bg-red-600 text-white px-4 py-2 rounded-full font-bold shadow-xl animate-enter">
        <i class="ph-bold ph-trash"></i> FULL RESET
    </button>

    <!-- Header Stats -->
    <header class="w-full max-w-md glass-card rounded-[2rem] p-3 mt-4 mb-4 flex justify-between items-center sticky top-2 z-40 animate-enter relative">
        
        <!-- Streak Badge -->
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-gradient-to-r from-orange-500 to-red-600 text-white px-3 py-1 rounded-full shadow-lg border-2 border-white dark:border-slate-800 flex items-center gap-1 z-50 cursor-help" title="Daily Streak">
            <i class="ph-fill ph-fire text-xs animate-pulse"></i>
            <span id="streakDisplay" class="text-xs font-black">1</span>
        </div>

        <!-- Coins -->
        <div class="flex flex-col items-center w-1/3 border-r border-black/10 dark:border-white/20 cursor-pointer hover:bg-black/5 dark:hover:bg-white/10 rounded-xl transition-colors py-1" onclick="aiReact('check_coins')">
            <div class="flex items-center gap-1.5 text-amber-500">
                <i class="ph-fill ph-coins text-2xl drop-shadow-sm"></i>
                <span id="coinDisplay" class="font-black text-xl tracking-tight" style="color: var(--text-main)">0</span>
            </div>
            <p class="text-[9px] font-extrabold uppercase tracking-widest mt-0.5" style="color: var(--text-muted)">Gold</p>
        </div>
        
        <!-- Timer -->
        <div class="flex flex-col items-center w-1/3">
            <div class="flex items-center gap-1.5 text-teal-600 dark:text-teal-400">
                <i class="ph-duotone ph-clock-countdown text-2xl animate-pulse"></i>
                <span id="timerDisplay" class="font-black text-xl tabular-nums tracking-tight" style="color: var(--text-main)">00:00:00</span>
            </div>
            <p class="text-[9px] font-extrabold uppercase tracking-widest mt-0.5" style="color: var(--text-muted)">Focus</p>
        </div>

        <!-- Tickets -->
        <div class="flex flex-col items-center w-1/3 border-l border-black/10 dark:border-white/20 cursor-pointer hover:bg-black/5 dark:hover:bg-white/10 rounded-xl transition-colors py-1" onclick="aiReact('check_tickets')">
            <div class="flex items-center gap-1.5 text-sky-600 dark:text-sky-400">
                <i class="ph-fill ph-ticket text-2xl drop-shadow-sm"></i>
                <span id="ticketDisplay" class="font-black text-xl tracking-tight" style="color: var(--text-main)">0</span>
            </div>
            <p class="text-[9px] font-extrabold uppercase tracking-widest mt-0.5" style="color: var(--text-muted)">Passes</p>
        </div>
    </header>

    <!-- Mascot & Progression Section -->
    <div id="heroMascot" class="flex flex-col items-center mb-6 w-full max-w-md animate-enter" style="animation-delay: 0.1s;">
        <div class="relative group w-full flex flex-col items-center">
            
            <!-- The Face -->
            <div id="bunnyFace" class="text-8xl drop-shadow-2xl animate-float cursor-pointer select-none transition-transform active:scale-90 active:rotate-3 z-10" onclick="interactMascot()">ğŸ°</div>
            
            <!-- XP & Level -->
            <div class="mt-3 w-full flex flex-col items-center z-10">
                <div class="flex justify-between w-40 mb-1">
                    <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-muted)">Lvl <span id="levelDisplay">1</span></span>
                    <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-muted)">XP</span>
                </div>
                <div class="w-40 h-2.5 xp-bar-container rounded-full overflow-hidden border border-black/5 dark:border-white/5">
                    <div id="xpBar" class="h-full bg-gradient-to-r from-violet-500 to-fuchsia-500 transition-all duration-500 ease-out shadow-[0_0_10px_rgba(167,139,250,0.5)]" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Speech Bubble -->
        <div class="glass-card rounded-2xl p-4 mt-4 relative w-full text-center transition-all duration-300 hover:scale-[1.01] shadow-md">
            <!-- Theme Toggle Prompt -->
            <div id="confirmationBox" class="hidden flex flex-col gap-3 mb-2 animate-enter">
                <p class="font-bold text-sm text-indigo-600 dark:text-indigo-400 flex items-center justify-center gap-2">
                    <i class="ph-fill ph-palette"></i> <span id="confirmText">Switch theme?</span>
                </p>
                <div class="flex gap-2 justify-center">
                    <button onclick="confirmTheme(true)" class="bg-black dark:bg-white text-white dark:text-black px-5 py-1.5 rounded-xl text-xs font-black shadow-lg active:scale-95 transition">YES</button>
                    <button onclick="confirmTheme(false)" class="bg-gray-400 text-white px-5 py-1.5 rounded-xl text-xs font-black shadow-lg active:scale-95 transition">NO</button>
                </div>
            </div>

            <p class="font-bold text-sm leading-relaxed flex items-center justify-center gap-2 min-h-[20px]" style="color: var(--text-main)" id="mascotText">
                <span class="animate-pulse">...</span>
            </p>
            <!-- Tail -->
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 glass-card border-t border-l border-black/10 dark:border-white/20 rotate-45 bg-inherit z-10"></div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="w-full max-w-md mb-6 sticky top-28 z-30 animate-enter" style="animation-delay: 0.2s;">
        <div class="flex gap-2 glass-card p-2 rounded-[1.8rem] shadow-xl ring-2 ring-transparent focus-within:ring-indigo-500/50 transition-all duration-300">
            <button onclick="generateDailyQuests(true)" class="btn-press bg-gradient-to-br from-violet-600 to-fuchsia-700 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg hover:shadow-violet-500/30" title="Force Daily Refresh">
                <i class="ph-bold ph-arrows-clockwise text-xl"></i>
            </button>
            
            <div class="flex-1 relative flex items-center">
                <input type="text" id="taskInput" 
                    oninput="checkSecretCommand(this)" 
                    onkeydown="if(event.key==='Enter') addTask()" 
                    placeholder="Type a quest..." 
                    class="bg-transparent w-full px-4 py-3 focus:outline-none font-bold"
                    style="color: var(--text-main);">
            </div>

            <button onclick="addTask()" class="btn-press bg-gradient-to-br from-teal-500 to-emerald-600 text-white px-5 rounded-2xl font-black shadow-lg hover:shadow-teal-500/30">
                <i class="ph-bold ph-plus text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Quest List -->
    <div id="questList" class="w-full max-w-md space-y-3 pb-8 min-h-[200px]">
        <!-- Quests inject here -->
    </div>

    <!-- Footer Controls -->
    <footer class="fixed bottom-0 w-full max-w-md glass-card border-t border-white/40 dark:border-white/10 p-4 pb-6 flex gap-4 rounded-t-[2.5rem] z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] animate-enter" style="animation-delay: 0.3s;">
        <!-- Buy Ticket -->
        <button onclick="buyTicket()" class="flex-1 btn-press bg-gradient-to-b from-amber-400 to-amber-600 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 shadow-amber-500/20 shadow-lg relative overflow-hidden group">
            <span class="text-[10px] font-black uppercase tracking-wider relative z-10">Shop</span>
            <div class="flex items-center gap-1 bg-black/10 px-2 py-0.5 rounded-full relative z-10">
                <i class="ph-fill ph-ticket text-xs"></i>
                <span class="text-xs font-bold">1000</span>
            </div>
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
        </button>

        <!-- Game Mode Toggle -->
        <button id="toggleBtn" onclick="toggleTimer()" class="btn-press bg-white dark:bg-slate-800 text-black dark:text-white w-20 h-20 -mt-12 rounded-full shadow-2xl flex items-center justify-center text-4xl z-50 border-4 border-white dark:border-slate-700 transition-colors">
            <i class="ph-fill ph-game-controller"></i>
        </button>

        <!-- Use Ticket -->
        <button onclick="useTicket()" class="flex-1 btn-press bg-gradient-to-b from-sky-400 to-blue-600 text-white py-3 rounded-2xl flex flex-col items-center justify-center gap-1 shadow-sky-500/20 shadow-lg relative overflow-hidden group">
            <span class="text-[10px] font-black uppercase tracking-wider relative z-10">Boost</span>
            <div class="flex items-center gap-1 bg-black/10 px-2 py-0.5 rounded-full relative z-10">
                <i class="ph-bold ph-clock text-xs"></i>
                <span class="text-xs font-bold">+1 Hr</span>
            </div>
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
        </button>
    </footer>

    <script>
        // --- 1. CONFIGURATION & ASSETS ---
        const SOUNDS = {
            pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            success: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
            error: new Audio('https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3'),
            cash: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'),
            magic: new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3'),
            daily: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
            unlock: new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3')
        };
        Object.values(SOUNDS).forEach(s => s.volume = 0.4);

        const DAILY_POOL = [
            "Drink a glass of water ğŸ’§", "Make the bed ğŸ›ï¸", "5 mins stretching ğŸ§˜", 
            "Read 10 pages ğŸ“–", "Clear desk ğŸ§¹", "Write 3 goals ğŸ“",
            "Send nice text ğŸ’¬", "20 jumping jacks ğŸƒ", "Meditate 5 mins ğŸ§˜â€â™‚ï¸",
            "Eat fruit ğŸ", "No phone 30 mins ğŸ“µ", "Clean inbox ğŸ“§",
            "Water plants ğŸŒ¿", "Listen to podcast ğŸµ", "Organize files ğŸ“‚",
            "Plan tomorrow ğŸ—“ï¸", "Walk 15m ğŸŒ³", "Deep breathe 2 min ğŸŒ¬ï¸",
            "Clean screen ğŸ’»", "Save $5 ğŸ–", "Study 30 mins ğŸ“š", "Gym workout ğŸ’ª"
        ];

        // --- 2. STATE MANAGEMENT ---
        let state = {
            username: null,
            coins: 0,
            tickets: 0,
            xp: 0,
            level: 1,
            streak: 1,
            lastLoginDate: null,
            gameSeconds: 0,
            isTimerActive: false,
            endTime: null,
            tasks: [],
            isDark: false
        };

        let mascotClicks = 0;
        let pendingTheme = null;
        let originalTitle = document.title;

        // --- 3. SMART DIALOGUES ---
        const DIALOGUES = {
            morning: [
                "Good morning, {name}! â˜€ï¸", "Rise and shine, {name}! â˜•", 
                "Let's conquer the day early! ğŸ¦", "The early bird gets the gold!", 
                "Fresh day, fresh goals, {name}!"
            ],
            afternoon: [
                "Keep the momentum going, {name}! ğŸš€", "Don't stop now, you're doing great! ğŸ’ª", 
                "Good afternoon! Stay focused!", "Hydrate and dominate! ğŸ’§", 
                "Halfway through the day, {name}!"
            ],
            evening: [
                "Good evening, {name}. Time to wrap up? ğŸŒ‡", "Finish strong, {name}! ğŸ¦‰", 
                "Reflect on your wins today.", "Almost time to rest.", 
                "You worked hard today, {name}."
            ],
            night: [
                "Burning the midnight oil? ğŸ•¯ï¸", "You should sleep soon, {name}. ğŸ˜´", 
                "Late night grind! Respect.", "Rest is important for XP too!", 
                "Good night, {name}. Recharge."
            ],
            rich: ["We are wealthy, {name}! ğŸ’°", "Look at all this gold!", "Investment time?"],
            poor: ["Funds are low, {name}... ğŸ¥º", "We need to work harder!", "A bit broke, aren't we?"],
            annoyed: ["Stop poking me, {name}! ğŸ‘‰", "I am not a toy!", "Focus on work, not me! ğŸ’¢"],
            encouragement: ["I believe in you, {name}! ğŸ”¥", "You are unstoppable!", "Legendary effort!"],
            rare: ["A HEROIC QUEST! âš”ï¸", "Big rewards ahead, {name}!", "This one is tough but worth it!"],
            levelup: ["LEVEL UP! You're stronger now! ğŸš€", "New heights reached! ğŸ’ª", "Evolution complete!"],
            welcome_back: ["Welcome back, {name}! ğŸ‘‹", "Ready to work?", "I missed you, {name}."]
        };

        // --- 4. AI & INTERACTION ---
        function formatMessage(text) {
            if (state.username && Math.random() < 0.4) {
                return text.replace('{name}', state.username);
            }
            return text.replace(', {name}', '').replace(' {name}', '');
        }

        function aiReact(trigger) {
            let msg = "";
            let face = "ğŸ°";
            const hour = new Date().getHours();

            switch(trigger) {
                case 'login':
                    if (hour >= 5 && hour < 12) msg = getRandom(DIALOGUES.morning);
                    else if (hour >= 12 && hour < 18) msg = getRandom(DIALOGUES.afternoon);
                    else if (hour >= 18 && hour < 23) msg = getRandom(DIALOGUES.evening);
                    else msg = getRandom(DIALOGUES.night);
                    break;
                case 'check_coins':
                    if(state.coins > 5000) { msg = getRandom(DIALOGUES.rich); face = "ğŸ¤‘"; }
                    else if(state.coins < 500) { msg = getRandom(DIALOGUES.poor); face = "ğŸ˜’"; }
                    else { msg = "Saving up for something big?"; face = "ğŸ§"; }
                    break;
                case 'poke':
                    mascotClicks++;
                    if(mascotClicks > 5) { msg = getRandom(DIALOGUES.annoyed); face = "ğŸ¤¬"; }
                    else if(mascotClicks > 2) { msg = "Hey! Watch the fur!"; face = "ğŸ§"; }
                    else { msg = getRandom(DIALOGUES.encouragement); face = "ğŸ¥°"; }
                    setTimeout(() => mascotClicks = 0, 5000);
                    break;
                case 'daily': msg = "New Daily Quests added! ğŸ“…"; face = "ğŸ¤©"; break;
                case 'complete': msg = "Quest Complete! Well done! ğŸ‰"; face = "ğŸ¤©"; break;
                case 'rare': msg = getRandom(DIALOGUES.rare); face = "ğŸ¤¯"; break;
                case 'levelup': msg = getRandom(DIALOGUES.levelup); face = "ğŸ§™â€â™‚ï¸"; break;
                case 'name_set': msg = `Nice to meet you, ${state.username}!`; face = "ğŸ‘‹"; break;
            }

            updateMascot(formatMessage(msg), face);
        }

        function updateMascot(text, faceEmoji) {
            const bubble = document.getElementById('mascotText');
            const face = document.getElementById('bunnyFace');
            
            bubble.style.opacity = 0;
            setTimeout(() => {
                bubble.innerHTML = text;
                bubble.style.opacity = 1;
            }, 200);

            face.innerText = faceEmoji;
            face.classList.remove('animate-float');
            void face.offsetWidth; 
            face.classList.add('animate-pop');
            
            setTimeout(() => {
                face.innerText = "ğŸ°";
                face.classList.remove('animate-pop');
                face.classList.add('animate-float');
            }, 3000);
        }

        function interactMascot() {
            SOUNDS.pop.play();
            aiReact('poke');
        }

        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        // --- 5. PROGRESSION SYSTEM (SCALING) ---
        function getXPThreshold(lvl) {
            return Math.floor(300 + (Math.pow(lvl, 1.8) * 200));
        }

        function getLevelProgress() {
            const currentLevelThreshold = getXPThreshold(state.level);
            const prevLevelThreshold = state.level === 1 ? 0 : getXPThreshold(state.level - 1);
            
            const xpInLevel = state.xp - prevLevelThreshold;
            const xpNeededForLevel = currentLevelThreshold - prevLevelThreshold;
            
            let pct = (xpInLevel / xpNeededForLevel) * 100;
            return Math.max(0, Math.min(100, pct));
        }

        function addXP(amount) {
            state.xp += amount;
            
            let threshold = getXPThreshold(state.level);
            
            if (state.xp >= threshold) {
                state.level++;
                state.tickets += 1; 
                SOUNDS.unlock.play();
                triggerConfetti({ particleCount: 150, spread: 100 });
                showToast(`LEVEL UP! You are Level ${state.level}! ğŸŸï¸ +1`);
                aiReact('levelup');
            }
        }

        function checkDailyQuests() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (state.lastLoginDate !== today) {
                if (state.lastLoginDate === yesterday) {
                    state.streak++;
                    showToast(`ğŸ”¥ Streak: ${state.streak} Days!`);
                } else if (state.lastLoginDate) {
                    state.streak = 1; 
                    showToast("Streak Reset ğŸ˜¢");
                } else {
                    state.streak = 1;
                }

                generateDailyQuests();
                state.lastLoginDate = today;
                saveData();
            } else {
                aiReact('login');
            }
        }

        function generateDailyQuests(force = false) {
            if(force) {
                SOUNDS.magic.play();
                const btn = document.querySelector('.ph-arrows-clockwise');
                btn.classList.add('animate-spin');
                setTimeout(()=> btn.classList.remove('animate-spin'), 1000);
            } else {
                SOUNDS.daily.play();
            }

            const shuffled = DAILY_POOL.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 5);

            selected.forEach((text, i) => {
                const exists = state.tasks.some(t => t.text === text && !t.completed);
                if(!exists) {
                    setTimeout(() => {
                        const taskData = evaluateTask(text);
                        taskData.isDaily = true;
                        taskData.isManual = false;
                        createTaskObject(text, taskData);
                    }, i * 100);
                }
            });
            if(force) aiReact('daily');
        }

        // --- 6. TASK LOGIC ---
        function evaluateTask(text) {
            const lower = text.toLowerCase();
            
            if (lower.includes('game') || lower.includes('play') || lower.includes('netflix')) 
                return { reward: 0, tier: "FORBIDDEN", icon: "ph-warning-octagon" };
            
            const rareKeywords = ['gym', 'study', 'work', 'project', 'run', 'code', 'exam', 'assignment', 'clean house', 'meeting', 'marathon'];
            if (rareKeywords.some(w => lower.includes(w))) {
                return { 
                    reward: Math.floor(Math.random() * (1000 - 800 + 1)) + 800, 
                    tier: "RARE", 
                    icon: "ph-sparkle" 
                };
            }

            const mediumKeywords = ['read', 'clean', 'organize', 'call', 'cook', 'mail', 'write', 'meditate', 'journal', 'walk'];
            if (mediumKeywords.some(w => lower.includes(w))) {
                return { 
                    reward: Math.floor(Math.random() * (799 - 600 + 1)) + 600, 
                    tier: "MEDIUM", 
                    icon: "ph-check-square" 
                };
            }

            return { 
                reward: Math.floor(Math.random() * (599 - 400 + 1)) + 400, 
                tier: "COMMON", 
                icon: "ph-check-circle" 
            };
        }

        function createTaskObject(text, evalData) {
            const task = {
                id: Date.now() + Math.random(),
                text: text,
                ...evalData,
                isManual: evalData.isManual !== undefined ? evalData.isManual : true,
                createdAt: Date.now()
            };
            state.tasks.push(task);
            saveData();
            renderQuests();
            
            const list = document.getElementById('questList');
            if(!evalData.isDaily) setTimeout(() => list.lastElementChild?.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text) return;

            if (text.toLowerCase() === 'reset') { input.value=''; return; }
            if (handleThemeCommand(text)) { input.value=''; return; }
            
            if (text.toLowerCase().startsWith('name ')) {
                const newName = text.substring(5).trim();
                if(newName) {
                    state.username = newName;
                    saveData();
                    aiReact('name_set');
                    showToast("Name Updated! ğŸ“");
                }
                input.value='';
                return;
            }

            const evalData = evaluateTask(text);
            evalData.isManual = true; 
            createTaskObject(text, evalData);
            
            SOUNDS.pop.play();
            if(evalData.tier === 'RARE') aiReact('rare');
            input.value = '';
        }

        function renderQuests() {
            const list = document.getElementById('questList');
            list.innerHTML = ''; 

            const sortedTasks = state.tasks.sort((a, b) => {
                if (a.isDaily && !b.isDaily) return -1;
                if (!a.isDaily && b.isDaily) return 1;
                return b.reward - a.reward;
            });

            sortedTasks.forEach(task => {
                const isRare = task.tier === 'RARE';
                const isMedium = task.tier === 'MEDIUM';
                const isForbidden = task.tier === 'FORBIDDEN';
                
                let borderColor, badgeClass, iconBg;
                if (isForbidden) {
                    borderColor = 'border-red-500'; badgeClass = 'bg-red-100 text-red-700'; iconBg = 'bg-red-100 text-red-600';
                } else if (isRare) {
                    borderColor = 'border-purple-500'; badgeClass = 'bg-purple-100 text-purple-900'; iconBg = 'bg-purple-100 text-purple-700';
                } else if (isMedium) {
                    borderColor = 'border-blue-500'; badgeClass = 'bg-blue-100 text-blue-900'; iconBg = 'bg-blue-100 text-blue-700';
                } else {
                    borderColor = 'border-slate-400 dark:border-slate-500'; badgeClass = 'bg-slate-200 text-black'; iconBg = 'bg-slate-200 text-black';
                }

                const div = document.createElement('div');
                div.className = `glass-card border-l-4 ${borderColor} p-4 rounded-2xl flex justify-between items-center animate-enter group relative overflow-hidden ${isRare ? 'shimmer' : ''}`;
                div.id = `task-${task.id}`;
                
                const tagHTML = `<span class="text-[9px] font-black uppercase tracking-wider py-0.5 px-2 rounded-md ${badgeClass}">${task.tier}</span>`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="w-10 h-10 rounded-full ${iconBg} flex items-center justify-center shrink-0"><i class="ph-fill ${task.icon} text-xl"></i></div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm truncate pr-2" style="color: var(--text-main)">${task.text}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${tagHTML}
                                <div class="flex items-center gap-1 bg-amber-100 dark:bg-amber-900/40 px-1.5 py-0.5 rounded-md">
                                    <i class="ph-fill ph-coins text-[10px] text-amber-600 dark:text-amber-400"></i>
                                    <span class="text-[10px] font-bold text-amber-800 dark:text-amber-300">${task.reward}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-0 items-center">
                        <button onclick="deleteTask(${task.id})" class="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-gray-400 hover:text-red-500"><i class="ph-bold ph-trash"></i></button>
                        <button onclick="completeTask(${task.id}, ${task.reward})" class="ml-2 btn-press w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-lg ${isForbidden ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-br from-teal-500 to-emerald-600'}" ${isForbidden ? 'disabled' : ''}><i class="ph-bold ph-check text-lg"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
            
            if(state.tasks.length === 0) {
                list.innerHTML = `
                    <div class="text-center p-8 opacity-60 animate-enter" style="color: var(--text-muted)">
                        <i class="ph-duotone ph-clipboard-text text-6xl mb-2"></i>
                        <p class="font-bold">All caught up!</p>
                        <p class="text-xs">Enjoy your free time.</p>
                    </div>`;
            }
        }

        function completeTask(id, reward) {
            const el = document.getElementById(`task-${id}`);
            if(el) { el.style.transform = "scale(0.95) translateX(10px)"; el.style.opacity = "0"; }

            setTimeout(() => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                state.coins += reward;
                
                const xpGain = Math.floor(reward * 0.4); 
                addXP(xpGain);

                SOUNDS.success.play();
                SOUNDS.cash.play();
                triggerConfetti();
                showToast(`+${reward} Gold | +${xpGain} XP`);
                aiReact('complete');
                
                updateUI(); renderQuests(); saveData();
            }, 300);
        }

        function deleteTask(id) {
            if(confirm("Abandon this quest?")) {
                state.tasks = state.tasks.filter(t => t.id !== id);
                renderQuests(); saveData();
            }
        }

        // --- 7. SHOP & UTILS ---
        function buyTicket() {
            if(state.coins >= 1000) {
                state.coins -= 1000;
                state.tickets++;
                SOUNDS.cash.play();
                triggerConfetti({ particleCount: 50, origin: { y: 0.9 } });
                showToast("Ticket Purchased! ğŸŸï¸");
                updateUI(); saveData();
            } else {
                SOUNDS.error.play(); showToast("Need 1000 Gold! ğŸ’¸"); aiReact('check_coins');
            }
        }

        function useTicket() {
            if(state.tickets > 0) {
                state.tickets--;
                if(state.isTimerActive) state.endTime += 3600000;
                else state.gameSeconds += 3600;
                SOUNDS.magic.play(); showToast("Time Extended! â³"); updateUI(); saveData();
            } else {
                SOUNDS.error.play(); showToast("No tickets left! ğŸŸï¸");
            }
        }

        function toggleTimer() {
            const btn = document.getElementById('toggleBtn');
            const icon = btn.querySelector('i');
            
            if (!state.isTimerActive) {
                if (state.gameSeconds <= 0) { showToast("Buy time first! â³"); return; }
                
                // Request Notification Permission
                if ("Notification" in window && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }

                state.isTimerActive = true;
                state.endTime = Date.now() + (state.gameSeconds * 1000);
                
                btn.classList.remove('bg-white', 'dark:bg-slate-800', 'text-black', 'dark:text-white');
                btn.classList.add('bg-sky-500', 'text-white', 'border-sky-600');
                icon.className = "ph-fill ph-pause text-white animate-pulse";
                showToast("Game Mode: ON ğŸ®");
            } else {
                state.isTimerActive = false;
                state.gameSeconds = Math.max(0, Math.floor((state.endTime - Date.now()) / 1000));
                state.endTime = null;
                document.title = originalTitle; // Reset title
                
                btn.classList.add('bg-white', 'dark:bg-slate-800', 'text-black', 'dark:text-white');
                btn.classList.remove('bg-sky-500', 'text-white', 'border-sky-600');
                icon.className = "ph-fill ph-game-controller";
                showToast("Game Mode: PAUSED â¸ï¸");
            }
            saveData();
        }

        // --- UPDATED TIMER LOGIC ---
        setInterval(() => {
            if (state.isTimerActive && state.endTime) {
                const now = Date.now();
                // Rely on Date.now() for accuracy (Works in background)
                const remaining = Math.max(0, Math.floor((state.endTime - now) / 1000));
                
                // Update Title for Desktop Tabs
                const timeString = formatTimeString(remaining);
                document.title = `${timeString} - Focus`;

                if (remaining <= 0) {
                    state.isTimerActive = false; state.gameSeconds = 0; state.endTime = null;
                    document.title = "Time's Up!";
                    toggleTimer();
                    
                    // Alert Logic
                    new Audio('https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3').play();
                    
                    // Send System Notification (Works on Lock Screen if allowed)
                    if ("Notification" in window && Notification.permission === "granted") {
                        new Notification("Questify", { 
                            body: "TIME'S UP! Great work! ğŸ°", 
                            icon: "https://unpkg.com/@phosphor-icons/web/assets/duotone/clock-countdown-duotone.svg" 
                        });
                    }
                    
                    alert("TIME UP! Back to work! ğŸ°");
                    document.title = originalTitle;
                }
                updateTimerDisplay(remaining);
            } else if (!state.isTimerActive) {
                updateTimerDisplay(state.gameSeconds);
                document.title = originalTitle;
            }
        }, 1000);

        // Updated Helper for HH:MM:SS
        function updateTimerDisplay(seconds) {
            document.getElementById('timerDisplay').innerText = formatTimeString(seconds);
        }

        function formatTimeString(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0'); // Added Seconds
            return `${h}:${m}:${s}`;
        }

        function updateUI() {
            document.getElementById('coinDisplay').innerText = state.coins.toLocaleString();
            document.getElementById('ticketDisplay').innerText = state.tickets;
            document.getElementById('levelDisplay').innerText = state.level;
            document.getElementById('streakDisplay').innerText = state.streak;
            document.getElementById('xpBar').style.width = `${getLevelProgress()}%`;
        }

        function triggerConfetti(opts = {}) {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#34d399', '#38bdf8'], disableForReducedMotion: true, ...opts });
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="ph-bold ph-info"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        // Theme & Data Logic
        function handleThemeCommand(text) {
            if(text.toLowerCase().includes('dark')) { promptTheme(true); return true; }
            if(text.toLowerCase().includes('light')) { promptTheme(false); return true; }
            return false;
        }
        function promptTheme(isDark) {
            pendingTheme = isDark;
            document.getElementById('confirmationBox').classList.remove('hidden');
            document.getElementById('confirmText').innerText = isDark ? "Go Dark?" : "Go Light?";
        }
        function confirmTheme(yes) {
            document.getElementById('confirmationBox').classList.add('hidden');
            if (yes) { state.isDark = pendingTheme; applyTheme(); saveData(); }
        }
        function applyTheme() { document.body.classList.toggle('dark-mode', state.isDark); }

        function checkSecretCommand(input) {
            if(input.value.toLowerCase() === 'reset') document.getElementById('resetBtn').style.display = 'block';
            else document.getElementById('resetBtn').style.display = 'none';
        }

        function triggerReset() {
            if(confirm("Delete EVERYTHING? Cannot be undone!")) {
                localStorage.removeItem('questifyData_Smart');
                location.reload();
            }
        }

        function saveData() { localStorage.setItem('questifyData_Smart', JSON.stringify(state)); }
        
        function askName() {
            let name = prompt("Hello Hero! What should I call you?");
            if (name && name.trim()) {
                state.username = name.trim();
                saveData();
                aiReact('name_set');
            } else {
                state.username = "Hero";
            }
        }

        function loadData() {
            const data = localStorage.getItem('questifyData_Smart');
            if(data) {
                const loaded = JSON.parse(data);
                state = { ...state, ...loaded };
                if(state.isTimerActive && state.endTime && Date.now() >= state.endTime) {
                    state.isTimerActive = false; state.gameSeconds = 0;
                }
            }
            
            applyTheme(); 
            updateUI(); 
            checkDailyQuests(); 
            renderQuests();

            if (!state.username) {
                setTimeout(askName, 500);
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
