<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questify - Background Timer Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-flow-1: #f0f9ff;
            --bg-flow-2: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-main: #334155;
            --accent: #0ea5e9;
        }

        .dark-mode {
            --bg-flow-1: #0f172a;
            --bg-flow-2: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.8);
            --text-main: #f1f5f9;
            --accent: #38bdf8;
        }

        @keyframes flow {
            0% { background-color: var(--bg-flow-1); }
            50% { background-color: var(--bg-flow-2); }
            100% { background-color: var(--bg-flow-1); }
        }

        body { 
            font-family: 'Nunito', sans-serif; 
            animation: flow 20s ease-in-out infinite;
            color: var(--text-main);
            transition: color 0.3s ease;
        }
        
        .duo-btn {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom-width: 5px;
            position: relative;
        }

        .duo-btn:hover { transform: translateY(-2px); filter: brightness(1.03); }
        .duo-btn:active { transform: translateY(4px); border-bottom-width: 0px; margin-bottom: 5px; }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes hop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .hop { animation: hop 2s infinite ease-in-out; }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #resetBtn { position: fixed; top: 20px; left: 20px; z-index: 1000; display: none; }
        
        .icon-coin { color: #f59e0b; fill: currentColor; width: 20px; height: 20px; }
        .icon-ticket { color: #0ea5e9; fill: currentColor; width: 24px; height: 24px; }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen">

    <button id="resetBtn" onclick="triggerReset()" class="duo-btn bg-red-500 border-red-700 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase shadow-xl">
        Reset Progress ‚ö†Ô∏è
    </button>

    <header class="w-full max-w-md glass-card rounded-3xl p-5 mb-10 flex justify-around items-center sticky top-4 z-50 shadow-lg">
        <div class="flex flex-col items-center">
            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">coins</p>
            <div class="flex items-center gap-1 font-black text-amber-500 text-xl">
                <svg class="icon-coin" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.39 2.1-1.39 1.47 0 2.01.59 2.06 1.47h1.73c-.06-1.54-1.12-2.67-2.78-3.05V5h-2v1.48c-1.47.31-2.72 1.28-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.74-2.32-1.47H8.35c.1 1.66 1.36 2.66 2.86 3.03V19h2v-1.47c1.55-.26 2.81-1.24 2.81-2.81 0-2.01-1.57-2.65-3.66-3.18z"/></svg>
                <span id="coinDisplay">0</span>
            </div>
        </div>
        <div class="flex flex-col items-center">
            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Tickets</p>
            <div class="flex items-center gap-1 font-black text-sky-500 text-xl">
                <svg class="icon-ticket" viewBox="0 0 24 24"><path d="M15.5 9.5c0 .827.673 1.5 1.5 1.5s1.5-.673 1.5-1.5S17.827 8 17 8s-1.5.673-1.5 1.5zm-9 0c0 .827.673 1.5 1.5 1.5s1.5-.673 1.5-1.5S8.827 8 8 8s-1.5.673-1.5 1.5zM22 7c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7zm-2 10H4V7h16v10z"/></svg>
                <span id="ticketDisplay">0</span>
            </div>
        </div>
        <div class="text-center">
            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Timer</p>
            <p class="text-xl font-black text-teal-500" id="timerDisplay">00:00:00</p>
        </div>
    </header>

    <div id="heroMascot" class="flex flex-col items-center mb-8">
        <div id="bunnyFace" class="text-8xl mb-4 drop-shadow-xl hop cursor-pointer" onclick="interactMascot()">üê∞</div>
        <div class="glass-card border-2 border-slate-100 rounded-2xl p-4 relative shadow-xl max-w-[280px] text-center">
            <div id="confirmationBox" class="hidden flex flex-col gap-2 mb-2">
                <p class="font-bold text-sm text-sky-500" id="confirmText">Switch theme?</p>
                <div class="flex gap-2 justify-center">
                    <button onclick="confirmTheme(true)" class="bg-teal-500 text-white px-3 py-1 rounded-lg text-xs font-black">YES</button>
                    <button onclick="confirmTheme(false)" class="bg-slate-400 text-white px-3 py-1 rounded-lg text-xs font-black">NO</button>
                </div>
            </div>
            <p class="font-bold text-sm" id="mascotText">Welcome back! I'm ready to grind! ‚ú®</p>
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 glass-card border-t-2 border-l-2 border-slate-100 rotate-45"></div>
        </div>
    </div>

    <div class="w-full max-w-md mb-10">
        <div class="flex gap-3 glass-card p-2 rounded-[2rem] shadow-xl">
            <input type="text" id="taskInput" oninput="checkSecretCommand(this)" onkeydown="if(event.key==='Enter') addTask()" placeholder="What is your quest?" class="bg-transparent flex-1 p-4 rounded-2xl focus:outline-none font-bold placeholder:text-slate-400">
            <button onclick="addTask()" class="duo-btn bg-teal-500 border-teal-700 text-white px-8 rounded-2xl font-black uppercase">Add</button>
        </div>
    </div>

    <div id="questList" class="w-full max-w-md space-y-4 mb-32"></div>

    <footer class="fixed bottom-0 w-full max-w-md glass-card border-t-2 border-white/20 p-6 flex gap-4 rounded-t-[3rem] z-40 shadow-2xl">
        <button onclick="buyTicket()" class="flex-1 duo-btn bg-amber-400 border-amber-600 text-white p-4 rounded-2xl font-black text-[10px] uppercase flex flex-col items-center justify-center">
            <span>Buy Ticket</span>
            <span class="opacity-80 flex items-center gap-1"><svg class="w-3 h-3 fill-white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg> 1000</span>
        </button>
        <button id="toggleBtn" onclick="toggleTimer()" class="duo-btn bg-white border-slate-200 p-4 rounded-full text-xl shadow-md text-slate-800">üéÆ</button>
        <button onclick="useTicket()" class="flex-1 duo-btn bg-sky-500 border-sky-700 text-white p-4 rounded-2xl font-black text-[10px] uppercase">Use Ticket<br><span class="opacity-80">+1 HR Time</span></button>
    </footer>

    <script>
        // --- CORE STATE ---
        let state = { 
            coins: 0, 
            tickets: 0, 
            gameSeconds: 0, 
            isTimerActive: false, 
            endTime: null, // Critical for background tracking
            tasks: [], 
            isDark: false 
        };
        let pendingTheme = null;

        // --- ASSETS ---
        const FACES = { normal: "üê∞", happy: "ü•≥", thinking: "ü§î", disappointed: "ü§®", angry: "üí¢" };
        const sounds = {
            add: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            done: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
            error: new Audio('https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3'),
            buy: new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3'),
            alarm: new Audio('https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3')
        };

        // --- BACKGROUND PERSISTENCE HACK ---
        // A silent audio loop prevents iOS/Android from "freezing" the JS execution
        const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
        silentAudio.loop = true;

        const DIALOGUES = {
            legendary: ["WHOA! A Legendary Quest?! ‚öîÔ∏è", "This is huge! You're a hero! üí™"],
            rare: ["Ooh, a challenge! I like it! üåü", "You're stepping up! ü•ï"],
            common: ["Steady progress is key! üëç", "Let's get this done! üèÉ‚Äç‚ôÇÔ∏è"],
            angry: ["*Twitch* No rewards for video games! üõë", "Work first, play later! üôÖ‚Äç‚ôÇÔ∏è"],
            jibberish: ["Huh? I don't speak 'keyboard-mash'! ü§®", "Is that a secret code? üìú"],
            complete: ["VICTORY! You did it! üéâ", "Cha-ching! ü™ô", "Unstoppable! ‚ú®"],
            themePrompt: ["Oh! Want to change the vibe?", "Should I switch the lights?", "Changing the scenery?"],
            darkToggle: ["Stealth mode engaged! üåë", "Ah, much better! üåô"],
            lightToggle: ["Bright and early! ‚òÄÔ∏è", "Let there be light! ‚ú®"]
        };

        // --- CORE FUNCTIONS ---
        function speak(type, face = 'normal') {
            const list = DIALOGUES[type];
            document.getElementById('mascotText').innerText = list[Math.floor(Math.random() * list.length)];
            document.getElementById('bunnyFace').innerText = FACES[face] || FACES.normal;
            if(face !== 'normal') setTimeout(() => document.getElementById('bunnyFace').innerText = FACES.normal, 3000);
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim().toLowerCase();
            if (!text || text === 'reset') return;

            if (text === 'dark' || text === 'dark mode') { promptTheme(true); input.value = ''; return; }
            if (text === 'light' || text === 'light mode') { promptTheme(false); input.value = ''; return; }

            if (isJibberish(text)) {
                sounds.error.play();
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 400);
                speak('jibberish', 'disappointed');
                return;
            }

            const eval = evaluateTask(text);
            state.tasks.push({ id: Date.now(), text: input.value, ...eval });
            sounds.add.play();
            input.value = '';
            renderQuests();
            saveData();
            speak(eval.tier.toLowerCase(), eval.tier === 'ANGRY' ? 'angry' : 'normal');
        }

        function evaluateTask(text) {
            if (text.includes('video game') || text.includes('play')) return { reward: 0, tier: "ANGRY", color: "text-red-600", bg: "bg-red-50" };
            const highEffort = ['exam', 'study', 'clean', 'workout', 'gym', 'run', 'homework', 'project', 'coding', 'math', 'work'];
            if (highEffort.some(word => text.includes(word))) return { reward: Math.floor(Math.random() * 201) + 800, tier: "LEGENDARY", color: "text-sky-600", bg: "bg-sky-50" };
            return { reward: Math.floor(Math.random() * 201) + 100, tier: "COMMON", color: "text-slate-500", bg: "bg-slate-100" };
        }

        // --- TIMER LOGIC (WITH BACKGROUND FIX) ---
        function toggleTimer() {
            if (state.gameSeconds <= 0 && !state.isTimerActive) return;

            state.isTimerActive = !state.isTimerActive;

            if (state.isTimerActive) {
                // Calculate future timestamp
                state.endTime = Date.now() + (state.gameSeconds * 1000);
                silentAudio.play().catch(() => console.log("Silent audio requires interaction first."));
            } else {
                // Save remaining seconds
                state.gameSeconds = Math.max(0, Math.floor((state.endTime - Date.now()) / 1000));
                state.endTime = null;
                silentAudio.pause();
                updateLockscreen("Timer Paused");
            }
            
            updateUI();
            saveData();
        }

        function updateLockscreen(timeStr) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: `Questify: ${timeStr}`,
                    artist: 'Stay Focused! üéÆ',
                    album: 'Game Session Active',
                    artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/3073/3073458.png', sizes: '512x512', type: 'image/png' }]
                });
            }
        }

        setInterval(() => {
            if (state.isTimerActive && state.endTime) {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((state.endTime - now) / 1000));

                const h = Math.floor(remaining / 3600).toString().padStart(2, '0');
                const m = Math.floor((remaining % 3600) / 60).toString().padStart(2, '0');
                const s = (remaining % 60).toString().padStart(2, '0');
                const timeStr = `${h}:${m}:${s}`;

                document.getElementById('timerDisplay').innerText = timeStr;
                updateLockscreen(timeStr);

                if (remaining <= 0) {
                    state.isTimerActive = false;
                    state.gameSeconds = 0;
                    state.endTime = null;
                    silentAudio.pause();
                    sounds.alarm.play();
                    updateUI();
                    alert("Game time is over! Back to quests! üê∞");
                }
            }
        }, 1000);

        // --- THEME & UI ---
        function promptTheme(dark) {
            pendingTheme = dark;
            document.getElementById('confirmationBox').classList.remove('hidden');
            document.getElementById('confirmText').innerText = dark ? "Switch to Dark Mode?" : "Switch to Light Mode?";
            speak('themePrompt', 'thinking');
        }

        function confirmTheme(yes) {
            document.getElementById('confirmationBox').classList.add('hidden');
            if (yes) {
                state.isDark = pendingTheme;
                applyTheme();
                saveData();
                speak(state.isDark ? 'darkToggle' : 'lightToggle', 'happy');
            }
            pendingTheme = null;
        }

        function applyTheme() { document.body.classList.toggle('dark-mode', state.isDark); }

        function renderQuests() {
            const list = document.getElementById('questList');
            list.innerHTML = '';
            state.tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = `glass-card border-2 ${task.reward === 0 ? 'border-red-500/50' : 'border-white/10'} p-5 rounded-3xl flex justify-between items-center shadow-sm`;
                card.innerHTML = `
                    <div class="max-w-[70%]">
                        <span class="${task.bg} ${task.color} text-[8px] px-2 py-0.5 rounded-full font-black uppercase border border-current tracking-widest">${task.tier}</span>
                        <p class="font-black text-sm mt-1 uppercase break-words">${task.text}</p>
                        <p class="text-xs font-bold ${task.reward === 0 ? 'text-red-400' : 'text-amber-500'}">ü™ô ${task.reward}</p>
                    </div>
                    <button onclick="completeTask(${task.id}, ${task.reward})" class="duo-btn ${task.reward === 0 ? 'bg-red-400 border-red-600' : 'bg-teal-400 border-teal-600'} text-white px-5 py-2 rounded-xl font-black text-xs uppercase shrink-0">DONE</button>
                `;
                list.appendChild(card);
            });
        }

        function updateUI() {
            document.getElementById('coinDisplay').innerText = state.coins;
            document.getElementById('ticketDisplay').innerText = state.tickets;
            const btn = document.getElementById('toggleBtn');
            btn.className = state.isTimerActive ? "duo-btn bg-sky-500 border-sky-700 p-4 rounded-full text-white" : "duo-btn bg-white border-slate-200 p-4 rounded-full shadow-md text-slate-800";
            
            // Re-render timer display manually if paused
            if(!state.isTimerActive) {
                const h = Math.floor(state.gameSeconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((state.gameSeconds % 3600) / 60).toString().padStart(2, '0');
                const s = (state.gameSeconds % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${h}:${m}:${s}`;
            }
        }

        // --- DATA MANAGEMENT ---
        function completeTask(id, reward) {
            state.coins += reward;
            state.tasks = state.tasks.filter(t => t.id !== id);
            sounds.done.play();
            speak('complete', 'happy');
            updateUI(); renderQuests(); saveData();
        }

        function buyTicket() {
            if (state.coins >= 1000) {
                state.coins -= 1000; state.tickets++;
                sounds.buy.play(); updateUI(); saveData();
            } else {
                speak('common', 'disappointed');
            }
        }

        function useTicket() {
            if (state.tickets > 0) {
                state.tickets--; 
                if (state.isTimerActive) {
                    state.endTime += 3600000; // Add 1 hour to end timestamp
                } else {
                    state.gameSeconds += 3600;
                }
                sounds.buy.play(); updateUI(); saveData();
            }
        }

        function isJibberish(text) {
            if (text.length < 3) return true;
            if (!/[aeiouy]/.test(text)) return true;
            return false;
        }

        function checkSecretCommand(input) {
            document.getElementById('resetBtn').style.display = (input.value.toLowerCase() === 'reset') ? 'block' : 'none';
        }

        function triggerReset() {
            if (confirm("Reset all progress? ü•∫")) { localStorage.clear(); location.reload(); }
        }

        function saveData() { localStorage.setItem('questifyData_v3', JSON.stringify(state)); }

        function loadData() {
            const saved = localStorage.getItem('questifyData_v3');
            if (saved) { 
                state = JSON.parse(saved); 
                // Recalculate background drift on load
                if (state.isTimerActive && state.endTime) {
                    const remaining = Math.floor((state.endTime - Date.now()) / 1000);
                    if (remaining <= 0) {
                        state.isTimerActive = false;
                        state.gameSeconds = 0;
                    }
                } else {
                    state.isTimerActive = false;
                }
                applyTheme(); renderQuests(); updateUI(); 
            }
        }
        window.onload = loadData;
    </script>
</body>
</html>
